{% load static %}
<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Formateur IA - PSC1 Training</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", system-ui, -apple-system, sans-serif;
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
        color: #333;
        transition: all 0.3s ease;
      }

      body.joker-mode {
        background: linear-gradient(135deg, #e91e63 0%, #ad1457 100%);
      }

      .container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 20px;
      }

      header {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        box-shadow: 0 2px 20px rgba(0, 0, 0, 0.1);
        position: sticky;
        top: 0;
        z-index: 100;
      }

      nav {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 0;
      }

      .logo {
        display: flex;
        align-items: center;
        gap: 10px;
        font-size: 1.5rem;
        font-weight: 700;
        color: #d32f2f;
        text-decoration: none;
      }

      .logo::before {
        content: "üöë";
        font-size: 1.8rem;
      }

      .nav-links {
        display: flex;
        gap: 2rem;
        list-style: none;
      }

      .nav-links a {
        text-decoration: none;
        color: #555;
        font-weight: 500;
        transition: color 0.3s ease;
      }

      .nav-links a:hover {
        color: #d32f2f;
      }

      .chat-container {
        display: flex;
        height: calc(100vh - 80px);
        gap: 20px;
        padding: 20px 0;
      }

      .sidebar {
        width: 300px;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        padding: 2rem;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        height: fit-content;
      }

      .trainer-info {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        border-radius: 15px;
        margin-bottom: 2rem;
        text-align: center;
      }

      .trainer-avatar {
        width: 80px;
        height: 80px;
        background: rgba(255, 255, 255, 0.2);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        margin: 0 auto 1rem;
      }

      .session-info {
        background: rgba(103, 126, 234, 0.05);
        padding: 1rem;
        border-radius: 10px;
        border-left: 4px solid #667eea;
        margin-bottom: 1.5rem;
      }

      .session-info h4 {
        color: #2c3e50;
        margin-bottom: 0.5rem;
      }

      .session-info p {
        font-size: 0.9rem;
        color: #666;
        margin-bottom: 0.3rem;
      }

      .points-info {
        background: rgba(76, 175, 80, 0.05);
        padding: 1rem;
        border-radius: 10px;
        border-left: 4px solid #4caf50;
      }

      .points-info h4 {
        color: #2c3e50;
        margin-bottom: 1rem;
      }

      .points-display {
        text-align: center;
      }

      .total-points {
        margin-bottom: 0.8rem;
      }

      .points-number {
        font-size: 2rem;
        font-weight: bold;
        color: #4caf50;
        text-shadow: 0 2px 4px rgba(76, 175, 80, 0.3);
      }

      .points-label {
        font-size: 0.9rem;
        color: #666;
        margin-left: 0.3rem;
      }

      .points-breakdown {
        display: flex;
        justify-content: space-between;
        gap: 1rem;
      }

      .point-type {
        background: white;
        padding: 0.5rem 0.8rem;
        border-radius: 8px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        flex: 1;
        text-align: center;
      }

      .point-icon {
        font-size: 1rem;
        margin-right: 0.3rem;
      }

      .point-desc {
        font-size: 0.8rem;
        color: #666;
      }

      .chat-main {
        flex: 1;
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border-radius: 20px;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .chat-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 1.5rem;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .status-indicator {
        width: 12px;
        height: 12px;
        background: #4caf50;
        border-radius: 50%;
        animation: pulse-green 2s infinite;
      }

      @keyframes pulse-green {
        0% {
          opacity: 1;
        }
        50% {
          opacity: 0.5;
        }
        100% {
          opacity: 1;
        }
      }

      .chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 2rem;
        display: flex;
        flex-direction: column;
        gap: 1rem;
      }

      .message {
        display: flex;
        gap: 1rem;
        max-width: 80%;
      }

      .message.user {
        align-self: flex-end;
        flex-direction: row-reverse;
      }

      .message-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        flex-shrink: 0;
      }

      .message.bot .message-avatar {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .message.user .message-avatar {
        background: #e3f2fd;
        color: #1976d2;
      }

      .message-content {
        background: white;
        padding: 1rem 1.5rem;
        border-radius: 20px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        position: relative;
      }

      .message.user .message-content {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .message-time {
        font-size: 0.75rem;
        color: #999;
        margin-top: 0.5rem;
      }

      .message.user .message-time {
        color: rgba(255, 255, 255, 0.8);
      }

      .scenario-card {
        background: rgba(255, 193, 7, 0.1);
        border: 2px solid rgba(255, 193, 7, 0.3);
        border-radius: 15px;
        padding: 1rem;
        margin: 1rem 0;
      }

      .scenario-card h4 {
        color: #f57c00;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .typing-indicator {
        display: none;
        align-items: center;
        gap: 1rem;
        padding: 1rem 0;
      }

      .typing-dots {
        display: flex;
        gap: 4px;
      }

      .typing-dot {
        width: 8px;
        height: 8px;
        background: #667eea;
        border-radius: 50%;
        animation: typing 1.4s infinite;
      }

      .typing-dot:nth-child(2) {
        animation-delay: 0.2s;
      }
      .typing-dot:nth-child(3) {
        animation-delay: 0.4s;
      }

      @keyframes typing {
        0%,
        60%,
        100% {
          transform: translateY(0);
        }
        30% {
          transform: translateY(-10px);
        }
      }

      .chat-input {
        background: white;
        border-top: 1px solid #eee;
        padding: 1.5rem;
      }

      .input-container {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .chat-input input {
        flex: 1;
        padding: 1rem 1.5rem;
        border: 2px solid #e0e0e0;
        border-radius: 25px;
        font-size: 1rem;
        outline: none;
        transition: all 0.3s ease;
      }

      .chat-input input:focus {
        border-color: #667eea;
        box-shadow: 0 0 0 3px rgba(103, 126, 234, 0.1);
      }

      .action-buttons {
        display: flex;
        gap: 0.5rem;
      }

      .send-btn,
      .joker-btn {
        width: 50px;
        height: 50px;
        border-radius: 50%;
        border: none;
        cursor: pointer;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        transition: all 0.3s ease;
      }

      .send-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .send-btn.mic-mode {
        background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      }

      .send-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(103, 126, 234, 0.4);
      }

      .send-btn.mic-mode:hover {
        box-shadow: 0 5px 15px rgba(255, 107, 107, 0.4);
      }

      .joker-btn {
        background: linear-gradient(135deg, #e91e63 0%, #ad1457 100%);
        color: white;
        position: relative;
      }

      .joker-btn:hover {
        transform: scale(1.05);
        box-shadow: 0 5px 15px rgba(233, 30, 99, 0.4);
      }

      .joker-btn::after {
        content: "üÉè";
        font-size: 1.5rem;
      }

      .joker-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(233, 30, 99, 0.95);
        backdrop-filter: blur(10px);
        z-index: 1000;
        display: none;
        align-items: center;
        justify-content: center;
        animation: fadeIn 0.3s ease;
      }

      @keyframes fadeIn {
        from {
          opacity: 0;
        }
        to {
          opacity: 1;
        }
      }

      .joker-content {
        background: white;
        border-radius: 20px;
        padding: 2rem;
        max-width: 800px;
        width: 90%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        animation: slideUp 0.3s ease;
      }

      @keyframes slideUp {
        from {
          opacity: 0;
          transform: translateY(50px);
        }
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }

      .joker-header {
        text-align: center;
        margin-bottom: 2rem;
      }

      .joker-header h2 {
        color: #e91e63;
        font-size: 1.8rem;
        margin-bottom: 0.5rem;
      }

      .joker-scenario {
        background: rgba(255, 193, 7, 0.1);
        border: 2px solid rgba(255, 193, 7, 0.3);
        border-radius: 15px;
        padding: 1.5rem;
        margin-bottom: 2rem;
      }

      .joker-scenario h4 {
        color: #f57c00;
        margin-bottom: 1rem;
        font-size: 1.2rem;
      }

      .joker-options {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 1rem;
        margin-bottom: 2rem;
      }

      .joker-option {
        background: white;
        border: 3px solid #e0e0e0;
        border-radius: 15px;
        padding: 1.5rem;
        cursor: pointer;
        transition: all 0.3s ease;
        text-align: left;
        display: flex;
        align-items: center;
        gap: 15px;
      }

      .joker-option:hover {
        border-color: #e91e63;
        background: rgba(233, 30, 99, 0.05);
        transform: translateY(-2px);
      }

      .joker-option.selected {
        border-color: #e91e63;
        background: linear-gradient(135deg, #e91e63 0%, #ad1457 100%);
        color: white;
        transform: translateY(-2px);
      }

      .option-letter {
        background: #e91e63;
        color: white;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 1.2rem;
        flex-shrink: 0;
      }

      .joker-option.selected .option-letter {
        background: white;
        color: #e91e63;
      }

      .joker-actions {
        display: flex;
        justify-content: center;
        gap: 1rem;
      }

      .joker-validate {
        background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        opacity: 0.5;
        pointer-events: none;
      }

      .joker-validate.active {
        opacity: 1;
        pointer-events: all;
      }

      .joker-validate:hover.active {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.4);
      }

      .joker-cancel {
        background: #f44336;
        color: white;
        border: none;
        padding: 1rem 2rem;
        border-radius: 25px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
      }

      .joker-cancel:hover {
        background: #d32f2f;
        transform: translateY(-2px);
      }

      @media (max-width: 768px) {
        .chat-container {
          flex-direction: column;
          height: auto;
        }

        .sidebar {
          width: 100%;
          order: 2;
          margin-top: 1rem;
        }

        .nav-links {
          display: none;
        }

        .joker-options {
          grid-template-columns: 1fr;
        }

        .joker-content {
          padding: 1.5rem;
        }
      }
    </style>
  </head>
  <body>
    <header>
      <nav class="container">
        <a href="#" class="logo">gardeReflexe</a>
        <ul class="nav-links">
          <li><a href="{% url 'reception' %}">Accueil</a></li>
        </ul>
      </nav>
    </header>

    <div class="container">
      <div class="chat-container">
        <aside class="sidebar">
          <div class="trainer-info">
            <div class="trainer-avatar">ü©∫</div>
            <h3>Dr. Sophie Martin</h3>
            <p>Formatrice PSC1 Virtuelle</p>
          </div>

          <div class="session-info">
            <h4>üìä Session Actuelle</h4>
            <p><strong>Niveau :</strong> R√©vision</p>
            <p><strong>Focus :</strong> Situations d'urgence</p>
            <p><strong>Dur√©e :</strong> 8 min</p>
          </div>

          <div class="points-info">
            <h4>üèÜ Compteur de Points</h4>
            <div class="points-display">
              <div class="total-points">
                <span class="points-number" id="totalPoints">0</span>
                <span class="points-label">points</span>
              </div>
              <div class="points-breakdown">
                <div class="point-type">
                  <span class="point-icon">‚úçÔ∏è</span>
                  <span class="point-desc"
                    >Cash: <span id="cashPoints">0</span>pts</span
                  >
                </div>
                <div class="point-type">
                  <span class="point-icon">üÉè</span>
                  <span class="point-desc"
                    >Joker: <span id="jokerPoints">0</span>pts</span
                  >
                </div>
              </div>
            </div>
          </div>
        </aside>

        <main class="chat-main">
          <div class="chat-header">
            <div class="status-indicator"></div>
            <div>
              <h2>Formateur IA - Session Active</h2>
              <p>Pr√™t √† vous accompagner dans votre r√©vision PSC1</p>
            </div>
          </div>

          <div class="chat-messages" id="chatMessages">
            <div class="message bot">
              <div class="message-avatar">ü©∫</div>
              <div class="message-content">
                <p>
                  Bonjour ! Je suis Dr. Sophie Martin, votre formatrice PSC1
                  virtuelle. Je suis ravie de vous retrouver pour cette session
                  de r√©vision.
                </p>
                <div class="scenario-card" id="currentScenario">
                  <h4>üé≠ Sc√©nario Initial</h4>
                  <p id="scenarioText">
                    Vous vous promenez dans un parc et vous voyez une personne
                    √¢g√©e qui tombe soudainement et ne bouge plus. Que
                    faites-vous en premier ?
                  </p>
                </div>
                <p>Tapez votre r√©ponse ou utilisez le Joker üÉè pour un QCM !</p>
                <div class="message-time">Il y a quelques secondes</div>
              </div>
            </div>
          </div>

          <div class="typing-indicator" id="typingIndicator">
            <div
              class="message-avatar"
              style="
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
              "
            >
              ü©∫
            </div>
            <div class="typing-dots">
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
              <div class="typing-dot"></div>
            </div>
            <span style="color: #666; font-size: 0.9rem"
              >Dr. Sophie tape...</span
            >
          </div>

          <div class="chat-input">
            <div class="input-container">
              <input
                type="text"
                id="messageInput"
                placeholder="Tapez votre r√©ponse ou utilisez le Joker pour un QCM..."
                oninput="toggleSendButton()"
              />
              <div class="action-buttons">
                <button
                  class="joker-btn"
                  onclick="showJoker()"
                  title="Mode QCM - Joker"
                ></button>
                <button
                  class="send-btn mic-mode"
                  id="sendBtn"
                  onclick="handleSendAction()"
                  title="Microphone"
                >
                  üé§
                </button>
              </div>
            </div>
          </div>
        </main>
      </div>
    </div>

    <!-- Joker Overlay -->
    <div class="joker-overlay" id="jokerOverlay">
      <div class="joker-content">
        <div class="joker-header">
          <h2>üÉè Mode Joker - QCM</h2>
          <p>Choisissez la bonne r√©ponse parmi les 4 propositions</p>
        </div>

        <div class="joker-scenario">
          <h4>üé≠ Rappel du Sc√©nario</h4>
          <p id="jokerScenarioText">
            Vous vous promenez dans un parc et vous voyez une personne √¢g√©e qui
            tombe soudainement et ne bouge plus. Que faites-vous en premier ?
          </p>
        </div>

        <div class="joker-options" id="jokerOptions">
          <div class="joker-option" onclick="selectJokerOption(this, 'A')">
            <div class="option-letter">A</div>
            <span>Je cours chercher de l'aide imm√©diatement</span>
          </div>
          <div class="joker-option" onclick="selectJokerOption(this, 'B')">
            <div class="option-letter">B</div>
            <span>Je v√©rifie si la personne est consciente</span>
          </div>
          <div class="joker-option" onclick="selectJokerOption(this, 'C')">
            <div class="option-letter">C</div>
            <span>Je commence un massage cardiaque</span>
          </div>
          <div class="joker-option" onclick="selectJokerOption(this, 'D')">
            <div class="option-letter">D</div>
            <span>Je d√©place la personne en s√©curit√©</span>
          </div>
        </div>

        <div class="joker-actions">
          <button class="joker-cancel" onclick="closeJoker()">Annuler</button>
          <button
            class="joker-validate"
            id="jokerValidate"
            onclick="validateJoker()"
          >
            Valider
          </button>
        </div>
      </div>
    </div>

    <script>
      const chatMessages = document.getElementById("chatMessages");
      const messageInput = document.getElementById("messageInput");
      const typingIndicator = document.getElementById("typingIndicator");
      const jokerOverlay = document.getElementById("jokerOverlay");
      const sendBtn = document.getElementById("sendBtn");

      let messageCount = 0;
      let selectedJokerOption = null;
      let cashResponseCount = 0; // Compteur pour les r√©ponses cash
      let points = {
        total: 0,
        cash: 0,
        joker: 0,
      };

      // Points pr√©d√©finis pour chaque r√©ponse cash dans l'ordre
      const cashPointsSequence = [15, 8, 12, 18, 6, 14, 10, 16, 4, 20, 7, 13];

      let currentScenarioData = {
        title: "üé≠ Sc√©nario Initial",
        text: "Vous vous promenez dans un parc et vous voyez une personne √¢g√©e qui tombe soudainement et ne bouge plus. Que faites-vous en premier ?",
        options: [
          { letter: "A", text: "Je cours chercher de l'aide imm√©diatement" },
          { letter: "B", text: "Je v√©rifie si la personne est consciente" },
          { letter: "C", text: "Je commence un massage cardiaque" },
          { letter: "D", text: "Je d√©place la personne en s√©curit√©" },
        ],
        correct: "B",
      };

      function toggleSendButton() {
        const hasText = messageInput.value.trim().length > 0;

        if (hasText) {
          sendBtn.classList.remove("mic-mode");
          sendBtn.innerHTML = "‚û§";
          sendBtn.title = "Envoyer";
        } else {
          sendBtn.classList.add("mic-mode");
          sendBtn.innerHTML = "üé§";
          sendBtn.title = "Microphone";
        }
      }

      function handleSendAction() {
        if (messageInput.value.trim().length > 0) {
          sendMessage();
        } else {
          // Action du micro - pour l'instant juste d√©coratif
          console.log("Micro cliqu√© - fonctionnalit√© √† venir");
        }
      }

      function updatePoints(type, points_earned) {
        points[type] += points_earned;
        points.total += points_earned;

        // Mettre √† jour l'affichage
        document.getElementById("totalPoints").textContent = points.total;
        document.getElementById("cashPoints").textContent = points.cash;
        document.getElementById("jokerPoints").textContent = points.joker;

        // Animation du score avec feedback visuel
        const totalElement = document.getElementById("totalPoints");
        totalElement.style.transform = "scale(1.3)";
        totalElement.style.color =
          points_earned > 15
            ? "#4caf50"
            : points_earned > 10
            ? "#ff9800"
            : "#f44336";

        // Cr√©er un √©l√©ment de feedback temporaire
        const feedback = document.createElement("div");
        feedback.style.position = "absolute";
        feedback.style.top = "-20px";
        feedback.style.left = "50%";
        feedback.style.transform = "translateX(-50%)";
        feedback.style.background =
          points_earned > 15
            ? "#4caf50"
            : points_earned > 10
            ? "#ff9800"
            : "#f44336";
        feedback.style.color = "white";
        feedback.style.padding = "4px 8px";
        feedback.style.borderRadius = "4px";
        feedback.style.fontSize = "0.8rem";
        feedback.style.fontWeight = "bold";
        feedback.style.zIndex = "1000";
        feedback.style.animation = "fadeInUp 0.5s ease";
        feedback.textContent = `+${points_earned}pts`;

        totalElement.parentElement.style.position = "relative";
        totalElement.parentElement.appendChild(feedback);

        setTimeout(() => {
          totalElement.style.transform = "scale(1)";
          totalElement.style.color = "#4caf50";
          feedback.remove();
        }, 1000);
      }

      function getCashPoints() {
        // Retourner les points pr√©d√©finis selon la s√©quence
        const pointsToAward =
          cashPointsSequence[cashResponseCount % cashPointsSequence.length];
        cashResponseCount++;
        return pointsToAward;
      }

      // R√©ponses automatiques du bot
      const botResponses = [
        {
          message:
            "Excellent r√©flexe ! V√©rifier la conscience est effectivement la premi√®re √©tape. La personne ne r√©pond pas √† vos appels.",
          scenario: {
            title: "üé≠ √âvolution du Sc√©nario",
            text: "Vous constatez que la personne est inconsciente. Elle semble respirer faiblement. Il y a quelques passants autour qui commencent √† s'approcher. Quelle est votre prochaine action ?",
            options: [
              {
                letter: "A",
                text: "Je place la personne en PLS imm√©diatement",
              },
              { letter: "B", text: "J'appelle le 15 et s√©curise les lieux" },
              { letter: "C", text: "Je demande aux passants de partir" },
              {
                letter: "D",
                text: "Je v√©rifie s'il y a des blessures visibles",
              },
            ],
            correct: "B",
          },
        },
        {
          message:
            "Parfait ! S√©curiser les lieux et appeler les secours sont des priorit√©s absolues. Le 15 a √©t√© contact√©, ils arrivent dans 8 minutes.",
          scenario: {
            title: "üé≠ Nouvelle Situation",
            text: "En attendant les secours, vous remarquez que la respiration devient tr√®s irr√©guli√®re. Un passant dit √™tre infirmier et propose son aide. Comment r√©agissez-vous ?",
            options: [
              { letter: "A", text: "Je refuse poliment et continue seul(e)" },
              { letter: "B", text: "J'accepte et on travaille ensemble" },
              { letter: "C", text: "Je lui demande ses dipl√¥mes d'abord" },
              { letter: "D", text: "Je lui laisse tout faire et je pars" },
            ],
            correct: "B",
          },
        },
        {
          message:
            "Tr√®s bien pens√© ! La collaboration avec un professionnel pr√©sent est toujours b√©n√©fique. Ensemble, vous surveillez les signes vitaux.",
          scenario: {
            title: "üé≠ Urgence Critique",
            text: "Soudain, la personne arr√™te de respirer. L'infirmier confirme l'absence de pouls. Vous devez maintenant agir rapidement !",
            options: [
              { letter: "A", text: "Chercher un d√©fibrillateur en premier" },
              { letter: "B", text: "Commencer imm√©diatement les compressions" },
              { letter: "C", text: "Faire du bouche-√†-bouche d'abord" },
              { letter: "D", text: "Attendre l'arriv√©e des secours" },
            ],
            correct: "B",
          },
        },
        {
          message:
            "Excellent ! Votre gestion de cette situation d'urgence a √©t√© exemplaire. Les secours sont arriv√©s et ont pris le relais avec succ√®s.",
          scenario: {
            title: "‚úÖ Sc√©nario Termin√© - Bilan",
            text: "F√©licitations ! Vous avez d√©montr√© une excellente ma√Ætrise des gestes PSC1. Score : 95/100",
            options: null,
          },
        },
      ];

      function showJoker() {
        // Mettre √† jour le contenu du joker avec le sc√©nario actuel
        document.getElementById("jokerScenarioText").textContent =
          currentScenarioData.text;

        // Cr√©er les options
        const optionsContainer = document.getElementById("jokerOptions");
        optionsContainer.innerHTML = "";

        if (currentScenarioData.options) {
          currentScenarioData.options.forEach((option) => {
            const optionDiv = document.createElement("div");
            optionDiv.className = "joker-option";
            optionDiv.onclick = () =>
              selectJokerOption(optionDiv, option.letter);
            optionDiv.innerHTML = `
              <div class="option-letter">${option.letter}</div>
              <span>${option.text}</span>
            `;
            optionsContainer.appendChild(optionDiv);
          });
        }

        jokerOverlay.style.display = "flex";
        document.body.style.overflow = "hidden";
      }

      function closeJoker() {
        jokerOverlay.style.display = "none";
        document.body.style.overflow = "auto";
        selectedJokerOption = null;

        // R√©initialiser les s√©lections
        document.querySelectorAll(".joker-option").forEach((opt) => {
          opt.classList.remove("selected");
        });
        document.getElementById("jokerValidate").classList.remove("active");
      }

      function selectJokerOption(element, letter) {
        // D√©s√©lectionner toutes les options
        document.querySelectorAll(".joker-option").forEach((opt) => {
          opt.classList.remove("selected");
        });

        // S√©lectionner l'option cliqu√©e
        element.classList.add("selected");
        selectedJokerOption = letter;

        // Activer le bouton de validation
        document.getElementById("jokerValidate").classList.add("active");
      }

      function validateJoker() {
        if (!selectedJokerOption) return;

        const selectedText = document.querySelector(
          ".joker-option.selected span"
        ).textContent;
        const userMessage = `üÉè JOKER - Option ${selectedJokerOption}: ${selectedText}`;

        // Calculer les points pour le joker
        const isCorrect = selectedJokerOption === currentScenarioData.correct;
        const jokerPoints = isCorrect ? 10 : 0; // Moiti√© des points max (20/2)

        // Fermer l'overlay
        closeJoker();

        // Ajouter le message de l'utilisateur
        addMessage(userMessage, true);

        // Ajouter les points
        if (jokerPoints > 0) {
          updatePoints("joker", jokerPoints);
        }

        // R√©pondre automatiquement
        setTimeout(() => {
          showTypingIndicator();
          setTimeout(() => {
            hideTypingIndicator();
            addMessage("", false);
          }, 2000 + Math.random() * 1000);
        }, 500);
      }

      function addMessage(content, isUser = false) {
        const messageDiv = document.createElement("div");
        messageDiv.className = `message ${isUser ? "user" : "bot"}`;

        const now = new Date();
        const timeStr = now.toLocaleTimeString("fr-FR", {
          hour: "2-digit",
          minute: "2-digit",
        });

        if (isUser) {
          messageDiv.innerHTML = `
            <div class="message-avatar">üë§</div>
            <div class="message-content">
              <p>${content}</p>
              <div class="message-time">${timeStr}</div>
            </div>
          `;
        } else {
          const response = botResponses[messageCount % botResponses.length];
          let scenarioHTML = "";

          if (response.scenario && response.scenario.options) {
            currentScenarioData = response.scenario;
            scenarioHTML = `
              <div class="scenario-card">
                <h4>${response.scenario.title}</h4>
                <p>${response.scenario.text}</p>
              </div>
              <p>Tapez votre r√©ponse ou utilisez le Joker üÉè pour un QCM !</p>
            `;
          } else if (response.scenario) {
            scenarioHTML = `
              <div class="scenario-card">
                <h4>${response.scenario.title}</h4>
                <p>${response.scenario.text}</p>
              </div>
            `;
          }

          messageDiv.innerHTML = `
            <div class="message-avatar">ü©∫</div>
            <div class="message-content">
              <p>${response.message}</p>
              ${scenarioHTML}
              <div class="message-time">${timeStr}</div>
            </div>
          `;
          messageCount++;
        }

        chatMessages.appendChild(messageDiv);
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function showTypingIndicator() {
        typingIndicator.style.display = "flex";
        chatMessages.scrollTop = chatMessages.scrollHeight;
      }

      function hideTypingIndicator() {
        typingIndicator.style.display = "none";
      }

      function sendMessage() {
        const message = messageInput.value.trim();
        if (message === "") return;

        // Obtenir les points pr√©d√©finis pour cette r√©ponse cash
        const cashPoints = getCashPoints();

        // Ajouter le message de l'utilisateur
        addMessage(`‚úçÔ∏è CASH: ${message}`, true);
        messageInput.value = "";

        // R√©initialiser le bouton
        toggleSendButton();

        // Ajouter les points avec animation
        updatePoints("cash", cashPoints);

        // Afficher l'indicateur de frappe
        showTypingIndicator();

        // Simuler le temps de r√©ponse du bot
        setTimeout(() => {
          hideTypingIndicator();
          addMessage("", false);
        }, 2000 + Math.random() * 1000);
      }

      // Gestion de l'envoi avec Entr√©e
      messageInput.addEventListener("keypress", function (e) {
        if (e.key === "Enter") {
          sendMessage();
        }
      });

      // Fermer le joker avec √âchap
      document.addEventListener("keydown", function (e) {
        if (e.key === "Escape" && jokerOverlay.style.display === "flex") {
          closeJoker();
        }
      });

      // Animation d'apparition des messages au chargement
      document.addEventListener("DOMContentLoaded", function () {
        const messages = document.querySelectorAll(".message");
        messages.forEach((msg, index) => {
          msg.style.opacity = "0";
          msg.style.transform = "translateY(20px)";
          setTimeout(() => {
            msg.style.transition = "all 0.5s ease";
            msg.style.opacity = "1";
            msg.style.transform = "translateY(0)";
          }, index * 200);
        });
      });
    </script>
  </body>
</html>
